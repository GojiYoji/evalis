# Architecture

Evalis is a **polyglot expression evaluator** designed for consistency, security, and maintainability across multiple programming languages.

## Core Principles

### 1. Single Source of Truth

**Grammar Definition** (`grammar/Evalis.g4`)

- ANTLR4 grammar defines the expression language syntax
- Shared across all language implementations
- Changes to the grammar automatically propagate to all implementations

**Test Oracle** (`test-oracle/cases.yml`)

- Single YAML file containing all test cases
- Each implementation runs the same tests
- Ensures behavioral consistency across languages
- Easy to add new test cases that benefit all implementations

### 2. Security

Evalis provides **sandboxed expression evaluation** decoupled from the language runtime. This prevents arbitrary code execution and other issues that arise with `eval()` approaches.

### 3. Consistency Across Languages

Each language implementation follows the same structure and exposes a similar API:

```
language/
├── src/
│   ├── __gen__/          # ANTLR-generated parser/lexer
│   ├── types.*           # AST node type definitions
│   ├── ast.*             # AST builder (ANTLR visitor)
│   ├── eval.*            # Expression evaluator
│   └── evalis.*          # Public API
├── tests/                # Test runner for shared test cases
├── generate.py           # Code generator for grammar enums
└── Makefile              # Build automation
```

## Data Flow

```
Expression String
    ↓
[ANTLR Lexer] → Tokens
    ↓
[ANTLR Parser] → Parse Tree
    ↓
[AST Builder Visitor] → Abstract Syntax Tree (i.e., EvalisNode)
    ↓
[Evaluator] → Result
```

## Supported Operations

- **Arithmetic**: `+`, `-`, `*`, `/`
- **Comparison**: `==`, `!=`, `<`, `<=`, `>`, `>=`
- **Logical**: `and`, `or`, `not`
- **Property access**: `obj.property`, `obj['key']`
- **Array access**: `arr[0]`
- **List comprehensions**: `[x * 2 for x in numbers]`
- **Membership**: `x in collection`
- **String literals**: Both `'single'` and `"double"` quotes

The `+` operator handles numbers, strings (with coercion), and arrays. Mixed types error.

## Build System

The repository uses Makefiles to provide a consistent build interface across languages:

- **Root Makefile** - Orchestrates all language implementations. Auto-generated by `support/generate_makefile.py` which discovers all language directories.
- **Language Makefiles** - Each `<language>/Makefile` provides standard targets: `build`, `test`, `lint`, `setup`, etc.
